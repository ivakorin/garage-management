# Система управления IoT‑устройствами

## Общее описание

Распределённая система для сбора, хранения и визуализации данных с IoT‑устройств. Состоит
из:

- **backend‑части** (обработка данных, интеграция с устройствами);

- **frontend‑части** (веб‑интерфейс);

- **инфраструктурных сервисов** (MQTT, БД, Redis).

Система обеспечивает:

- динамическую загрузку плагинов устройств;

- сбор и хранение показаний;

- публикацию данных в MQTT;

- визуализацию в реальном времени;

- API для интеграции и мониторинга.

## Архитектура системы

### 1\. Backend (`backend/`)

**Основные компоненты:**

- **`api/`**  
  REST‑API (v1) на FastAPI для взаимодействия с внешними системами.

- **`core/`**  
  Базовые настройки и утилиты: конфигурация, логирование, глобальные настройки приложения.

- **`crud/`**  
  Слои доступа к данным — реализация CRUD‑операций для работы с сущностями системы.

- **`db/`**  
  Модуль работы с базой данных (SQLAlchemy 2.0 + aiosqlite):

    - инициализация БД;

    - управление сессиями;

    - файл базы данных (SQLite).

- **`models/`**  
  ORM‑модели для сущностей системы:

    - плагины;

    - сенсоры;

    - настройки.

- **`plugins/`**  
  Каталог плагинов устройств — расширяемая часть системы для поддержки различных датчиков
  и устройств. Включает шаблоны и примеры реализации.

- **`schemas/`**  
  Pydantic‑схемы для валидации входных и выходных данных API.

- **`services/`**  
  Сервисные модули:

    - клиент MQTT;

    - менеджер плагинов;

    - менеджер WebSocket‑соединений.

- **`tasks/`**  
  Фоновые задачи — модули для периодического выполнения операций (например, сбор данных с
  устройств).

- **`utils/`**  
  Вспомогательные функции и утилиты, используемые в разных частях приложения.

- **`main.py`**  
  Точка входа в приложение — запуск FastAPI и фоновых задач.

- **`mock/`**  
  Моки для тестирования — имитация внешних зависимостей (например, MQTT‑сервера).

### 2\. Frontend (`frontend/`)

Веб‑интерфейс на **Vue 3** с поддержкой локализации и интерактивной визуализацией данных.

**Основные директории:**

- **`src/`**  
  Ядро фронтенда:

    - корневой компонент приложения;

    - UI‑компоненты (графики, виджеты);

    - настройка локализации;

    - переводы;

    - маршрутизация;

    - глобальные стили.

- **`public/`**  
  Статические ресурсы, доступные напрямую (иконки, изображения).

- **`vite.config.ts`**  
  Конфигурация сборочного инструмента (Vite).

- **`package.json`**  
  Описание зависимостей и скриптов сборки/запуска.

**Ключевые возможности:**

- визуализация данных с датчиков в реальном времени (ECharts);

- управление устройствами через WebSocket;

- локализация интерфейса;

- адаптивный дизайн;

- навигация через vue‑router.

### 3\. Инфраструктурные сервисы (`services/`)

- **MQTT (`mosquitto/`)**  
  Брокер сообщений для обмена данными с устройствами.

- **Redis**  
  Система кэширования и временного хранения данных.

- **Docker и развёртывание**

    - `docker-compose.yaml` — оркестрация контейнеров;

    - Dockerfile для backend и frontend — описание образов;

    - `nginx/` — конфигурация прокси‑сервера;

    - `systemd/` — юниты для управления сервисами через systemd.

## Ключевые возможности системы

1. **Динамическая загрузка плагинов**  
   Плагины размещаются в `plugins/` и автоматически подключаются. Каждый плагин получает
   стабильный `device_id` (хранится в БД).

2. **Сохранение данных**

    - история показаний — в таблице `device_data`;

    - метаданные устройств — в таблице `devices`;

    - реестр плагинов — в таблице `plugin_registry`.

3. **Интеграция с MQTT**

    - данные публикуются в топики `devices/{device_id}/data`;

    - поддержка подписки на команды.

4. **Реальное время**

    - WebSocket для мгновенных обновлений в интерфейсе;

    - фоновые задачи для сбора данных.

5. **Масштабируемость**

    - модульная архитектура (легко добавлять новые плагины и эндпоинты);

    - поддержка Docker для развёртывания.

6. **Безопасность**

    - аутентификация в MQTT;

    - валидация данных через Pydantic‑схемы.

7. **Мониторинг**

    - логирование всех операций;

    - API для диагностики.

## Требования

- Python 3.14+;

- Node.js 18+ (для фронтенда);

- Docker и Docker Compose;

- Redis;

- Mosquitto MQTT;

- SQLite (для БД).

## Запуск системы

### 1\. Установка зависимостей

**Backend:**

bash

```bash
poetry install
```

**Frontend:**

bash

```bash
cd frontend
npm install
```

### 2\. Сборка и запуск

**Через Docker Compose (рекомендуемый способ):**

### Переменные окружения

Все переменные имеют префикс `GM__`. Значения по умолчанию указаны там, где применимо.

- **`GM__REDIS__HOST`**  
  Хост Redis.  
  *Значение по умолчанию:* `127.0.0.1`

- **`GM__REDIS__PORT`**  
  Порт Redis.  
  *Значение по умолчанию:* `6379`

- **`GM__MQTT__HOST`**  
  Хост MQTT‑брокера.  
  *Значение по умолчанию:* `127.0.0.1`


- **`GM__MQTT__PORT`**  
  Порт MQTT‑брокера.  
  *Значение по умолчанию:* `1884`

- **`GM__MQTT__USERNAME`**  
  Имя пользователя для аутентификации в MQTT.  
  *Значение по умолчанию:* `mqtt`

- **`GM__MQTT__PASSWORD`**  
  Пароль для аутентификации в MQTT.  
  *Значение по умолчанию:* `mqtt`

- **`GM__APP_SETTINGS__KEEP_DATA`**  
  Срок хранения данных (в днях).  
  *Значение по умолчанию:* `7`

- **`GM__LOG__LEVEL`**  
  Уровень логирования.  
  *Значение по умолчанию:* `INFO`  
  *Допустимые значения:* `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`

- **`GM__API__URL`**  
  Адрес API для фронтенда.  
  *Значение по умолчанию:* `http://127.0.0.1:8000/api/v1`

- **`GM__WS__URL`**  
  Адрес WebSocket для фронтенда.  
  *Значение по умолчанию:* `ws://127.0.0.1:8000/api/v1/ws`

---

**Примечание:**

- Переменные `GM__API__URL` и `GM__WS__URL` используются во фронтенде (подставляются через
  Nginx/envsubst).
- Для продакшена значения следует задавать явно при запуске контейнера (через `-e` в
  Docker или в `docker-compose.yaml`).

bash

```bash
docker-compose -f services/docker/docker-compose.yaml up
```

**Локальный запуск backend:**

bash

```bash
python backend/main.py
```

**Локальный запуск frontend:**

bash

```bash
cd frontend
npm run dev
```

### 3\. Проверка работы

- Backend: `http://localhost:8000` (API и документация);

- Frontend: `http://localhost:5173` (веб‑интерфейс);

- MQTT: порт `1883` (по умолчанию);

- Redis: порт `6379` (по умолчанию).

## Документация

Подробная информация по отдельным модулям и API доступна в директории `docs/`:

[//]: # (- `api-specs.md` — спецификации API;)

[//]: # ()

- `architecture.md` — архитектура системы;

[//]: # ()

- `deployment.md` — развёртывание и эксплуатация;

[//]: # ()

[//]: # (- `modules.md` — описание модулей;)

[//]: # ()

[//]: # (- `troubleshooting.md` — устранение неполадок;)

- `MQTTdevices`- подключение внешних устройств.