# Система управления IoT‑устройствами

## Общее описание

Распределённая система для сбора, хранения и визуализации данных с IoT‑устройств. Состоит
из:

- **backend‑части** (обработка данных, интеграция с устройствами);
- **frontend‑части** (веб‑интерфейс);
- **инфраструктурных сервисов** (MQTT, БД, Redis).

Система обеспечивает:

- динамическую загрузку плагинов устройств;
- сбор и хранение показаний;
- публикацию данных в MQTT;
- визуализацию в реальном времени;
- API для интеграции и мониторинга.

## Архитектура системы

### 1. Backend (`backend/`)

**Основные модули:**

- **`api/api_v1/endpoints/`**  
  REST‑API (v1) на FastAPI:
    - `mqtt.py` — управление MQTT‑подключениями;
    - `sensors.py` — работа с данными датчиков;
    - `websocket.py` — реал‑тайм обновления через WebSocket.

- **`core/`**  
  Базовые настройки и утилиты:
    - `config.py` — конфигурация приложения;
    - `logging.py` — настройка логирования;
    - `settings.py` — глобальные настройки.

- **`crud/`**  
  Слои доступа к данным (CRUD‑операции для сенсоров).

- **`db/`**  
  Работа с базой данных (SQLAlchemy 2.0 + aiosqlite):
    - `database.py` — инициализация БД;
    - `session.py` — управление сессиями;
    - `database.db` — файл БД (SQLite).

- **`models/`**  
  ORM‑модели:
    - `plugins.py` — модель плагина;
    - `sensor.py` — модель сенсора;
    - `settings.py` — модели настроек.

- **`plugins/`**  
  Каталог для плагинов устройств:
    - `DS18B20_mux_plugin.py` — пример плагина для датчиков температуры;
    - `template.py` — шаблон для новых плагинов.

- **`schemas/`**  
  Pydantic‑схемы для валидации данных (например, `sensor.py`).


- **`services/`**  
  Сервисные модули:
    - `mqtt_client.py` — клиент MQTT (aiomqtt);
    - `plugins.py` — загрузка и управление плагинами.

- **`tasks/`**  
  Фоновые задачи:
    - `data_collector.py` — сбор данных с устройств.

- **`utils/`**  
  Вспомогательные функции (например, `helpers.py`).

- **`main.py`**  
  Точка входа в приложение (запуск FastAPI + фоновых задач).

- **`mock/`**  
  Моки для тестирования (например, `mqtt_mock.py`).

### 2. Frontend (`frontend/`)

Веб‑интерфейс на **Vue 3** с поддержкой локализации (ru/en) и интерактивной
визуализацией (ECharts).

**Структура:**

- **`src/`**
    - `App.vue` — корневой компонент;
    - `components/` — UI‑компоненты (графики, виджеты);
    - `i18n.ts` — настройка локализации;
    - `locales/` — переводы (ru.json, en.json);
    - `router/` — маршрутизация;
    - `style.css` — глобальные стили.

- **`public/`**  
  Статические ресурсы.

- **`vite.config.ts`**  
  Конфигурация сборки (Vite).


- **`package.json`**  
  Зависимости и скрипты.

**Возможности:**

- визуализация данных с датчиков в реальном времени (ECharts);
- управление устройствами через WebSocket;
- локализация интерфейса (vue-i18n);
- адаптивный дизайн (Naive UI);
- навигация через vue-router.

### 3. Инфраструктурные сервисы

- **MQTT (`mosquitto/`)**  
  Брокер сообщений для обмена данными с устройствами:
    - `config/` — конфигурация;
    - `data/` — данные;
    - `init-mqtt.sh` — скрипт инициализации.

- **Redis (`redis/`)**  
  Кэширование и временное хранение данных:
    - `data/` — директория с данными.


- **Docker и развёртывание (`services/`)**
    - `docker-compose.yml` — оркестрация контейнеров;
    - `backend.Dockerfile` / `frontend.Dockerfile` — образы;
    - `nginx/` — конфигурация прокси;
    - `systemd/` — юниты для systemd (сервисы API, коллектора, Redis).

## Ключевые возможности системы

1. **Динамическая загрузка плагинов**
    - Плагины размещаются в `plugins/` и автоматически подключаются.
    - Каждый плагин получает стабильный `device_id` (хранится в БД).

2. **Сохранение данных**
    - История показаний — в таблице `device_data`.
    - Метаданные устройств — в таблице `devices`.
    - Реестр плагинов — в таблице `plugin_registry`.


3. **Интеграция с MQTT**
    - Данные публикуются в топики `devices/{device_id}/data`.
    - Поддержка подписки на команды.


4. **Реальное время**
    - WebSocket для мгновенных обновлений в интерфейсе.
    - Фоновые задачи для сбора данных.


5. **Масштабируемость**
    - Модульная архитектура (легко добавлять новые плагины и эндпоинты).
    - Поддержка Docker для развёртывания.


6. **Безопасность**
    - Аутентификация в MQTT.
    - Валидация данных через Pydantic‑схемы.


7. **Мониторинг**
    - Логирование всех операций.
    - API для диагностики.

## Требования

- Python 3.14+;
- Node.js 18+ (для frontend);
- Docker и Docker Compose;
- Redis;
- Mosquitto MQTT;
- SQLite (для БД).

## Запуск системы

### 1. Установка зависимостей

**Backend:**

```bash
poetry install
